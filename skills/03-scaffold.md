# Skill 03: Scaffold — Set Up Command Registry Infrastructure

## Goal

Set up the command registry infrastructure in the target project. This creates the core files (registry, defineCommand, middleware pipeline) as new files alongside the existing codebase. **No existing files are modified.**

---

## Inputs

- `wrapex-output/refactoring-plan.json` (from Skill 02)
- The wrapex `templates/` directory
- User's configuration decisions (ID prefix, middleware choices)

## Output

A new directory in the target project containing the registry infrastructure:
```
<project-root>/
└── wrapex-output/
    └── commands/
        ├── core/
        │   ├── define-command.ts
        │   ├── command-registry.ts
        │   ├── middleware-pipeline.ts
        │   └── index.ts
        └── index.ts       # Re-exports registry instance
```

---

## Steps

### Step 1: Choose Output Location

The default location is `wrapex-output/commands/` at the project root. This keeps all wrapex artifacts separate from the existing codebase.

If the project has a `src/` directory, an alternative is `src/commands/`. Ask the user if they prefer this.

### Step 2: Copy Core Templates

Copy these files from the wrapex `templates/` directory to `wrapex-output/commands/core/`:

1. `define-command.ts` — Copy as-is.
2. `command-registry.ts` — Copy as-is.
3. `middleware-pipeline.ts` — Copy as-is.

These files are self-contained TypeScript with a single dependency on `zod`.

### Step 3: Create the Registry Instance

Create `wrapex-output/commands/index.ts` that instantiates the registry with the user's chosen middleware:

```typescript
/**
 * Command Registry — singleton instance for the application.
 * Generated by wrapex scaffold. Customize middleware here.
 */

import { createRegistry } from './core/command-registry';
import {
  errorBoundaryMiddleware,
  loggingMiddleware,
  validationMiddleware,
} from './core/middleware-pipeline';

// CONFIGURE: Add or remove middleware as needed.
// Available: errorBoundaryMiddleware, loggingMiddleware, validationMiddleware
// See templates/telemetry-middleware.ts for Sentry/analytics middleware.
export const registry = createRegistry({
  middleware: [
    errorBoundaryMiddleware,
    loggingMiddleware,
    validationMiddleware,
  ],

  // CONFIGURE: Implement when-clause evaluation against your app's context.
  // Example for Zustand:
  //   evaluateWhen: (clause) => {
  //     const state = useAppStore.getState();
  //     return evaluateWhenClause(clause, state);
  //   },

  // CONFIGURE: Provide app context to command handlers.
  // Example for Zustand:
  //   contextProvider: () => ({
  //     store: useAppStore,
  //   }),
});
```

### Step 4: Create Core Index

Create `wrapex-output/commands/core/index.ts`:

```typescript
export { defineCommand } from './define-command';
export type {
  CommandDefinition,
  CommandContext,
  CommandResult,
  Keybinding,
} from './define-command';

export { createRegistry } from './command-registry';
export type {
  CommandRegistry,
  CommandMiddleware,
  WhenClauseEvaluator,
  RegistryConfig,
} from './command-registry';

export {
  errorBoundaryMiddleware,
  loggingMiddleware,
  validationMiddleware,
  createConfirmationMiddleware,
  createDefaultMiddleware,
} from './middleware-pipeline';
```

### Step 5: Verify TypeScript Compilation

Run the TypeScript compiler on the new files to verify they compile:

```bash
npx tsc --noEmit wrapex-output/commands/core/*.ts
```

If the project uses a `tsconfig.json`, ensure the new directory is included (or that `tsc` can resolve `zod`). If `zod` is not already a dependency, add it:

```bash
npm install zod
# or: pnpm add zod / yarn add zod
```

### Step 6: Create Commands Directory Structure

Create directories for command definition files, organized by category:

```
wrapex-output/commands/
├── core/               # (already created above)
├── definitions/        # Command definition files go here
│   └── .gitkeep
└── index.ts            # (already created above)
```

The `definitions/` directory will be populated by Skill 04 (Wrap).

---

## Validation Checklist

- [ ] `wrapex-output/commands/core/define-command.ts` exists and compiles
- [ ] `wrapex-output/commands/core/command-registry.ts` exists and compiles
- [ ] `wrapex-output/commands/core/middleware-pipeline.ts` exists and compiles
- [ ] `wrapex-output/commands/core/index.ts` exports all types and functions
- [ ] `wrapex-output/commands/index.ts` creates a registry instance
- [ ] `zod` is available as a dependency
- [ ] No existing files were modified
- [ ] The registry can be imported and instantiated without errors
